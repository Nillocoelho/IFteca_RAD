{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Salas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'salas/styles.css' %}">
</head>
<body>
    <div class="layout">
        <header class="topbar">
            <div class="brand">
                <div class="brand-logo">
                    <i data-lucide="building-2"></i>
                </div>
                <div>
                    <div class="title">IFTECA</div>
                    <div class="subtitle">Sistema de Reserva de Salas - IFPB</div>
                </div>
            </div>
            <div class="user-area">
                <span class="small text-muted">{{ request.user.get_full_name|default:request.user.username|default:"Administrador" }}</span>
                <span class="user-pill">Admin</span>
                <a href="{% url 'logout' %}" class="logout-link text-decoration-none fw-semibold">
                    <i data-lucide="log-out"></i>
                    <span>Sair</span>
                </a>
            </div>
        </header>

        <div class="shell">
            <aside class="sidebar d-flex flex-column">
                <nav class="nav flex-column">
                    <a class="nav-link" href="#"><i class="bi bi-speedometer2"></i>Dashboard</a>
                    <a class="nav-link active" aria-current="page" href="{% url 'gerenciar_salas' %}"><i class="bi bi-door-open-fill"></i>Gerenciar Salas</a>
                    <a class="nav-link" href="#"><i class="bi bi-people-fill"></i>Gerenciar Usuários</a>
                    <a class="nav-link" href="#"><i class="bi bi-calendar-event"></i>Gerenciar Reservas</a>
                </nav>
            </aside>

            <main class="content">
                <div class="page-header mb-4">
                    <h1>Gerenciar Salas</h1>
                    <p>Adicione, edite ou remova salas do sistema</p>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center gap-3 header-actions">
                        <div>
                            <h5 class="mb-1">Lista de Salas</h5>
                            <small class="text-secondary">Visualize todas as salas cadastradas no sistema</small>
                        </div>
                        <div class="d-flex align-items-center gap-3 actions-right">
                            <div class="search-box">
                                <i class="bi bi-search"></i>
                                <input type="search" id="searchInput" class="form-control" placeholder="Buscar sala..." aria-label="Buscar sala">
                            </div>
                            <button class="btn btn-primary-ifpb" data-bs-toggle="modal" data-bs-target="#modalSala">
                                <i class="bi bi-plus-lg me-2"></i>Adicionar Sala
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="modalSavedFeedback" class="alert alert-success d-none" role="alert"></div>
                        <div class="table-responsive">
                            <table class="table align-middle mb-0" id="salasTable">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Andar</th>
                                        <th>Capacidade</th>
                                        <th>Status</th>
                                        <th>Equipamentos</th>
                                        <th class="text-end">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="salasTableBody">
                                    {% if salas %}
                                        {% for sala in salas %}
                                        <tr data-id="{{ sala.id }}" data-nome="{{ sala.nome }}" data-andar="{{ sala.andar|default_if_none:'' }}" data-tipo="{{ sala.tipo }}" data-equipamentos="{{ sala.equipamentos|join:"," }}" data-descricao="{{ sala.descricao|default_if_none:'' }}">
                                            <td class="fw-semibold sala-nome">{{ sala.nome }}</td>
                                            <td class="sala-andar">{{ sala.andar }}</td>
                                            <td class="sala-capacidade">{{ sala.capacidade }} pessoas</td>
                                            <td>
                                                {% if sala.status == "Disponivel" %}
                                                    <span class="status-pill status-available">Disponivel</span>
                                                {% elif sala.status == "Ocupada" %}
                                                    <span class="status-pill status-occupied">Ocupada</span>
                                                {% elif sala.status == "Em Manutencao" %}
                                                    <span class="status-pill status-maintenance">Em Manutencao</span>
                                                {% else %}
                                                    <span class="status-pill status-maintenance">{{ sala.status }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="equipments">
                                                    {% for eq in sala.equipamentos|slice:":2" %}
                                                        <span class="equip-tag">{{ eq }}</span>
                                                    {% endfor %}
                                                    {% if sala.equipamentos|length > 2 %}
                                                        <span class="equip-more">+{{ sala.equipamentos|length|add:"-2" }}</span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td class="text-end sala-actions">
                                                <button class="btn btn-sm btn-edit text-primary me-2" data-id="{{ sala.id }}" title="Editar"><i class="bi bi-pencil"></i></button>
                                                <button class="btn btn-sm btn-delete text-danger" data-id="{{ sala.id }}" title="Excluir"><i class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr class="js-empty-row">
                                            <td colspan="6" class="empty-state">Nenhuma sala cadastrada ainda.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Adicionar Sala -->
    <div class="modal fade" id="modalSala" tabindex="-1" aria-labelledby="modalSalaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalSalaLabel">Adicionar Nova Sala</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger d-none" role="alert">
                        <ul id="modalErrors" class="mb-0"></ul>
                    </div>
                    <div id="modalSuccess" class="alert alert-success d-none" role="alert"></div>
                    <form class="row g-3" id="modalSalaForm" novalidate>
                        {% csrf_token %}
                        <div class="col-md-6">
                            <label class="form-label fw-semibold" for="modalNome">Nome da Sala</label>
                            <input type="text" id="modalNome" name="nome" class="form-control" placeholder="Ex: Sala 101" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold" for="modalAndar">Andar</label>
                            <input type="text" id="modalAndar" name="andar" class="form-control" placeholder="Ex: 1º Andar" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold" for="modalCapacidade">Capacidade</label>
                            <input type="number" min="1" id="modalCapacidade" name="capacidade" class="form-control" placeholder="Ex: 20" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold" for="modalStatus">Status</label>
                            <select class="form-select" id="modalStatus" name="status" required>
                                <option value="" selected disabled>Selecione</option>
                                <option value="Disponivel">Disponivel</option>
                                <option value="Ocupada">Ocupada</option>
                                <option value="Em Manutencao">Em Manutencao</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold" for="modalTipo">Tipo</label>
                            <select class="form-select" id="modalTipo" name="tipo" required>
                                <option value="" selected disabled>Selecione</option>
                                {% for tipo in tipos %}
                                <option value="{{ tipo }}">{{ tipo }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold" for="modalEquip">Equipamentos (separados por vírgula)</label>
                            <input type="text" id="modalEquip" name="equipamentos" class="form-control" placeholder="Projetor, Quadro branco, Ar condicionado">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold" for="modalDesc">Descrição</label>
                            <textarea id="modalDesc" name="descricao" class="form-control" rows="3" placeholder="Descrição da sala..."></textarea>
                        </div>
                        <input type="hidden" id="modalSalaId" name="id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" form="modalSalaForm" class="btn btn-success">Adicionar Sala</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="{% static 'salas/forms.js' %}"></script>
    <script>
        if (window.lucide) {
            window.lucide.createIcons();
        }
        // Busca por nome ou andar
        const searchInput = document.getElementById("searchInput");
        const tableRows = document.querySelectorAll("#salasTableBody tr");

        searchInput?.addEventListener("input", () => {
            const term = searchInput.value.toLowerCase().trim();
            tableRows.forEach((row) => {
                const nome = row.getAttribute("data-nome")?.toLowerCase() || "";
                const andar = row.getAttribute("data-andar")?.toLowerCase() || "";
                const matches = nome.includes(term) || andar.includes(term);
                row.style.display = matches ? "" : "none";
            });

            const anyVisible = Array.from(tableRows).some((row) => row.style.display !== "none");
            const emptyRow = document.querySelector(".js-empty-row");
            if (emptyRow) {
                emptyRow.style.display = anyVisible ? "none" : "";
            }
        });
    </script>
</body>
</html>

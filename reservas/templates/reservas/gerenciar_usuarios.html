{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerenciar Usuários — IFTECA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'reservas/gerenciar_usuarios.css' %}">
</head>
<body data-is-admin="{{ is_admin|yesno:'true,false' }}">
  <header class="admin-header">
    <div class="header-brand">
      <i class="bi bi-building"></i>
      <div>
        <div class="brand-title">IFTECA</div>
        <div class="brand-subtitle">Sistema de Reserva de Salas - IFPB</div>
      </div>
    </div>
    <div class="header-user">
      <div class="user-info">
        <i class="bi bi-person-circle"></i>
        <span>{% if is_admin %}Administrador{% else %}Gestor{% endif %}</span>
      </div>
      <span class="admin-badge">{% if is_admin %}Admin{% else %}Staff{% endif %}</span>
      <a href="{% url 'logout' %}" class="btn-sair">
        <i class="bi bi-box-arrow-right"></i>
        <span>Sair</span>
      </a>
    </div>
  </header>

  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <nav class="sidebar-nav">
        <a href="{% url 'admin_dashboard' %}" class="nav-item">
          <i class="bi bi-grid-1x2"></i>
          <span>Dashboard</span>
        </a>
        <a href="{% url 'gerenciar_salas_ui' %}" class="nav-item">
          <i class="bi bi-door-open"></i>
          <span>Gerenciar Salas</span>
        </a>
        <a href="{% url 'gerenciar_usuarios' %}" class="nav-item active">
          <i class="bi bi-people"></i>
          <span>Gerenciar Usuários</span>
        </a>
        <a href="{% url 'admin_reservas' %}" class="nav-item">
          <i class="bi bi-calendar-check"></i>
          <span>Gerenciar Reservas</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="content-header">
        <div>
          <h1>Gerenciar Usuários</h1>
          <p class="text-muted">Visualize e gerencie os usuários do sistema</p>
        </div>
      </div>

      <div class="content-body">
        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-title">Total de Usuários</div>
            <div class="stat-value">{{ total_usuarios }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Usuários Ativos</div>
            <div class="stat-value">{{ usuarios_ativos }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Estudantes</div>
            <div class="stat-value">{{ total_estudantes }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Professores</div>
            <div class="stat-value">{{ total_professores }}</div>
          </div>
        </div>

        <!-- Users Table Card -->
        <div class="users-card">
          <div class="card-header">
            <h2>Lista de Usuários</h2>
            <div class="filters">
              <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" id="searchInput" placeholder="Buscar usuário...">
              </div>
              <select id="filterTipo" class="filter-select">
                <option value="">Todos os tipos</option>
                <option value="estudante">Estudante</option>
                <option value="professor">Professor</option>
                <option value="admin">Administrador</option>
              </select>
              <select id="filterStatus" class="filter-select">
                <option value="">Todos</option>
                <option value="ativo">Ativos</option>
                <option value="inativo">Inativos</option>
              </select>
            </div>
          </div>

          <div id="feedback" class="alert d-none" role="alert"></div>

          <div class="table-container">
            <table class="users-table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>E-mail</th>
                  <th>Matrícula/SIAPE</th>
                  <th>Tipo</th>
                  <th>Status</th>
                  <th>Reservas</th>
                  <th class="text-end">Ações</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                {% for usuario in usuarios %}
                <tr data-id="{{ usuario.id }}" 
                    data-nome="{{ usuario.nome }}" 
                    data-email="{{ usuario.email }}" 
                    data-tipo="{{ usuario.tipo }}" 
                    data-status="{{ usuario.status }}">
                  <td class="user-name">{{ usuario.nome }}</td>
                  <td class="user-email">{{ usuario.email }}</td>
                  <td class="user-matricula">{{ usuario.matricula }}</td>
                  <td>
                    <span class="badge-tipo badge-{{ usuario.tipo }}">{{ usuario.tipo_display }}</span>
                  </td>
                  <td>
                    <span class="badge-status badge-{{ usuario.status }}">{{ usuario.status_display }}</span>
                  </td>
                  <td class="user-reservas">{{ usuario.reservas_count }}</td>
                  <td class="text-end">
                    <div class="action-buttons">
                      {% if is_admin %}
                      <button class="btn-action btn-toggle {% if usuario.is_active %}btn-deactivate{% else %}btn-activate{% endif %}" 
                              title="{% if usuario.is_active %}Desativar usuário{% else %}Ativar usuário{% endif %}"
                              data-id="{{ usuario.id }}"
                              data-active="{{ usuario.is_active|yesno:'true,false' }}">
                        <i class="bi {% if usuario.is_active %}bi-toggle-on{% else %}bi-toggle-off{% endif %}"></i>
                      </button>
                      {% else %}
                      <button class="btn-action btn-toggle btn-action-disabled" 
                              title="Apenas administradores podem alterar status de usuários"
                              disabled>
                        <i class="bi {% if usuario.is_active %}bi-toggle-on{% else %}bi-toggle-off{% endif %}"></i>
                      </button>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr class="empty-row">
                  <td colspan="7" class="text-center text-muted py-4">Nenhum usuário encontrado.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Paginação -->
          {% if page_obj.has_other_pages %}
          <div class="pagination-container">
            <nav aria-label="Navegação de páginas">
              <ul class="pagination pagination-sm">
                {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                    <i class="bi bi-chevron-left"></i>
                  </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                  <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                  {% if page_obj.number == num %}
                  <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                  {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ num }}</a>
                  </li>
                  {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                    <i class="bi bi-chevron-right"></i>
                  </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                  <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
          {% endif %}
        </div>
      </div>
    </main>
  </div>

  <!-- Modal de Confirmação -->
  <div class="modal fade" id="modalConfirm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Confirmar Ação</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p id="modalMessage">Tem certeza que deseja realizar esta ação?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirm">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'reservas/gerenciar_usuarios.js' %}"></script>
</body>
</html>
